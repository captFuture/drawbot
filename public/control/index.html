<!-- TODO: General cleanup; separate script, css, etc. -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta id="viewport" name="viewport"
        content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Drawbot Control</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.4/rgbcolor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/radialIndicator.min.js"></script>
    <style>
        body,
        * {
            border: 0;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: sans-serif;
        }

        #control {
            margin: 33vh 0 0 0;
            position: relative;
        }

        .level {
            position: absolute;
            border-radius: 100%;
            overflow: hidden;
        }

        .horizontal {
            width: 100vw;
            height: 15vw;
            padding-top: 8vw
        }

        .horizontal .item {
            float: left;
            margin-left: 1vh
        }

        .vertical {
            position: absolute;
            width: 64vw;
            height: 15vw;
            margin-top: -22vw;
            padding-left: 27vw;
        }

        .vertical .item {
            float: left;
            margin-left: 1vh
        }

        .top{
            
        }

        .bottom{
            padding-top: 39vh;
        }

        .item {
            display: block;
            border: 1.5vw solid green;
            color: white;
            font-weight: bold;
            border-radius: 100%;
        }

        .one {
            width: 20vh;
            height: 20vh;
        }
        .two {
            margin-top: 2vh;
            width: 15vh;
            height: 15vh;
        }
        .three {
            margin-top: 4vh;
            width: 10vh;
            height: 10vh;
        }
        .extended{
            margin-left:37vh!important;
        }

        .item:active {
            background: black;
        }


        /* separate circle buttons */
        .btn {
            display: block;
            position: absolute;
            border-radius: 100%;
            border: 3px solid gray;
            width: 18vw;
            height: 18vw;
            text-align: center;
            line-height: 17vw;
            text-decoration: none;
            color: gray;
            background: white;
            font-size: 6vw;
            font-weight: bold;
        }

        .btn:active {
            background: black;
            color: white;
        }

        .btn i {
            line-height: 17vw;
        }

        .close {
            border-color: white;
            top: 2vw;
            right: 2vw;
        }

        .close2 {
            border-color: white;
            top: 2vw;
            right: 2vw;
        }

        .clearcanvas {
            top: 56vw;
            left: 2vw;
            border-color: white;
        }

        .pen {
            top: 6vw;
            left: 38.5vw;
            border-color: white;
        }

        .up {
            border-color: red;
        }
        .down {
            border-color: green;
        }

        .home {
            top: 2vw;
            left: 2vw;
            border-color: white;
        }

        .sethome {
            top: 2vw;
            left: 20vw;
            border-color: white;
            display:none;
        }

        .settings {
            top: 2vw;
            right: 2vw;
            border-color: white;
        }

        .progress {
            top: 2vw;
            right: 20vw;
            border-color: white;
        }

        .pause {
            margin: 0;
            left: 17vw;
        }

        .reboot {
            margin: 0;
            right: 17vw;
        }

        .dragover {
            opacity: 0.5;
        }

        #home {
            visibility: hidden;
            border-color: green;
            display:none;
        }

        #settings {
            visibility: hidden;
            border-color: red;
            display:none;
        }
        #progress {
            visibility: hidden;
            border-color: blue;
            display:none;
        }

        .on {
            visibility: visible !important;
            display:block !important;
        }

        #dxy {
            font-size: 6vw;
            font-weight: bold;
            width: 66vw;
            margin: 0 10.5vw;
            padding-top: 17vw;
            color: gray;
        }

        input {
            font-size: 10vw;
            font-weight: regular;
            width: 46vw;
            padding: 1vh 3vw;
            text-align: center;
            border-radius: 10vw;
            color: gray;
        }

        input:focus {
            background: black;
            color: white;
        }

        input:focus~label {
            color: black;
        }

        label {
            position: relative;
            bottom: 3vw;
        }

        label i {
            width: 8vw;
            padding: 2vw;
            text-align: center;
        }

        *:focus {
            outline: none;
        }

        #botid {
            text-align: center;
            position: absolute;
            top: 2vw;
            left: 0;
            width: 100vw;
            font-size: 10px;
            font-weight: normal;
            color: gray;
        }

        #connection {
            color: lightgray;
            display: block;
            position: absolute;
            width: 10vw;
            left: 42vw;
            top: 8vw;
            text-align: center;
        }

        .disconnected {
            color: red !important;
        }

        .rebooting {
            color: orange !important;
        }

        .connected {
            color: green !important;
        }

        #percentage {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            width: 25vw;
            height: 25vw;
            top: 50vw;
            right: 2vw;
        }
    </style>
</head>

<body>
    <div id="main">
        <!-- <h1 id="botid">one</h1> -->
        <div id="connection" class="fa fa-circle"></div>
        <div class="page on" id="home">
            <a href="#" class="btn home"><i class="fa  fa-home fa-1x"></i></a>
            <a href="#" class="btn sethome"><i class="fa  fa-plus-circle fa-1x"></i></a>
            <a href="#" class="btn settings"><i class="fa  fa-gear fa-1x"></i></a>
            <a href="#" class="btn progress"><i class="fa  fa-sticky-note fa-1x"></i></a>
            <a href="#" class="btn clearcanvas"><i class="fa  fa-minus-circle fa-1x"></i></a>
            <div id="percentage" class=""></div>
            <div id="control">
               
                <div class="horizontal">
                    <div class="">
                        <a data-d="h" data-x="-100" data-y="0" class="item one"></a>
                        <a data-d="h" data-x="-10" data-y="0" class="item two"></a>
                        <a data-d="h" data-x="-1" data-y="0" class="item three "></a>
                        <a data-d="h" data-x="1" data-y="0" class="item three extended"></a>
                        <a data-d="h" data-x="10" data-y="0" class="item two"></a>
                        <a data-d="h" data-x="100" data-y="0" class="item one"></a>
                    </div>
                </div>

                <div class="vertical">
                    <div class="top">
                        <a data-d="v" data-y="-100" data-x="0" class="item one"></a>
                        <a data-d="v" data-y="-10" data-x="0" class="item two"></a>
                        <a data-d="v" data-y="-1" data-x="0" class="item three "></a>
                    </div>
                    <div class="bottom">
                        <a data-d="v" data-y="1" data-x="0" class="item three"></a>
                        <a data-d="v" data-y="10" data-x="0" class="item two"></a>
                        <a data-d="v" data-y="100" data-x="0" class="item one"></a>
                    </div>
                </div>
                

                <a href="#" id="penButton" class="btn pen">PEN</a>
            </div>
        </div>
        <div class="page" id="settings">
            <a href="#" class="btn close"><i class="fa fa-close fa-1x"></i></a>
            <form id="dxy">
                <div>
                    <label for="d"><i class="fa fa-arrows-h"></i> D:</label>
                    <input type="number" value="0" min="0" inputmode="numeric" pattern="[0-9]*" id="d" name="d">
                </div>
                <div>
                    <label for="startx"><i class="fa fa-long-arrow-right"></i> X:</label>
                    <input type="number" value="0" min="0" inputmode="numeric" pattern="[0-9]*" id="startx"
                        name="startx">
                </div>
                <div>
                    <label for="starty"><i class="fa fa-long-arrow-down"></i> Y:</label>
                    <input type="number" value="0" min="0" inputmode="numeric" pattern="[0-9]*" id="starty"
                        name="starty">
                </div>
            </form>
            <a href="#" class="btn pause"><i class="fa fa-pause fa-1x"></i></a>
            <a href="#" class="btn reboot"><i class="fa fa-refresh fa-1x"></i></a>
        </div>
        <div class="page" id="progress">
            <a href="#" class="btn close2"><i class="fa fa-close fa-1x"></i></a>
            <canvas id="originCanvas" width="480" height="600">
                        
            </canvas>
            <canvas id="progressCanvas" width="480" height="600">
                
            </canvas>
        </div>
    </div>





    <script>
        var connectionIndicator = document.querySelector('#connection')

        var socket = io.connect('/');
        socket.on('connected', function (data) {
            console.log('connected!');
            socket.emit('getDXY');
            socket.emit('checkBotConnection', { socketID: socket.id });
        });

        var flipper = document.querySelector('#main');

        var penz = 0;
        let pads = document.querySelectorAll('.item');
        for (var i = 0; i < pads.length; i++) {
            //console.log(pads[i])
            let pad = pads[i];
            pad.addEventListener('click', handleTouch);
        }

        function handleTouch(e) {
            e.preventDefault()
            var data = this.dataset
            console.log(data)
            socket.emit('r', data)
            //console.log(data);
        }

        var pen = document.querySelector('.pen');
        pen.addEventListener('click', function (e) {
            penz = !penz// swap pen position
            var data = {
                up: penz
            }
            socket.emit('pen', data);
        });

        var home = document.querySelector('.home');
        home.addEventListener('click', function (e) {
            var data = { x: 0, y: 0 }
            socket.emit('moveto', data);
        });

        // TODO change the way the gui movement works -> then set startpoint works correctly
        /*var sethome = document.querySelector('.sethome');
            sethome.addEventListener('click', function (e) {
                var data = {
                    x: 0,
                    y: 0
                }
                socket.emit('setStartPos', data)
            });
        */

        var settingsButton = document.querySelector('.settings');
        settingsButton.addEventListener('click', function (e) {
            toggleSettings();
        });

        var settingsPage = document.querySelector('#settings');
        var homePage = document.querySelector('#home');
        function toggleSettings() {
            settingsPage.classList.toggle('on');
            homePage.classList.toggle('on');
        }

        var progressButton = document.querySelector('.progress');
        progressButton.addEventListener('click', function (e) {
            toggleProgress();
        });

        var progressPage = document.querySelector('#progress');
        var homePage = document.querySelector('#home');
        function toggleProgress() {
            progressPage.classList.toggle('on');
            homePage.classList.toggle('on');
        }

        var closeButton2 = document.querySelector('.close2');
        closeButton2.addEventListener('click', function (e) {
            toggleProgress();
        });

        var clearcanvasButton = document.querySelector('.clearcanvas');
        clearcanvasButton.addEventListener('click', function (e) {
            socket.emit('clearCanvas')
        })

        var percentageIndicator = document.querySelector('#percentage')
        var ri = radialIndicator('#percentage', {
            barColor: 'gray',
            barWidth: 5,
            initValue: 0,
            radius: 15,
            percentage: true
        })
        socket.on('progressUpdate', function (data) {
            ri.animate(data.percentage)
        });

        socket.on('progressDraw', function (data) {
            console.log(data);
            var cmdCode = data.cmd
            var x = data.x
            var y = data.y
            var tox0 = data.x0
            var toy0 = data.y0
            var tox1 = data.x1
            var toy1 = data.y1
            var tox2 = data.x2
            var toy2 = data.y2
            var pen = data.pen
            var progcanvas = document.getElementById("originCanvas");
            var progctx = progcanvas.getContext("2d");

            var penButton = document.getElementById("penButton");
            switch (pen) {
                case 0:
                    // pen is down
                    penButton.classList.remove('up')
                    penButton.classList.add('down')
                break

                case 1:
                    // pen is up
                    penButton.classList.remove('down')
                    penButton.classList.add('up')
                break
            }
            
            switch (cmdCode) {
                case 'L':
                    progctx.beginPath();
                    progctx.lineWith = "1";
                    progctx.strokeStyle = "#FF0000"
                    progctx.moveTo(x, y);
                    progctx.lineTo(tox0, toy0);
                    progctx.stroke();
                break
                case 'V':
                    progctx.beginPath();
                    progctx.lineWith = "1";
                    progctx.strokeStyle = "#FF0000"
                    progctx.moveTo(x, y);
                    progctx.lineTo(tox0, toy0);
                    progctx.stroke();
                break
                case 'C':
                    progctx.beginPath();
                    progctx.lineWith = "1";
                    progctx.strokeStyle = "#FF0000"
                    progctx.moveTo(x, y);
                    
                    progctx.bezierCurveTo(tox1, toy1, tox2, toy2, tox0, toy0);
                    progctx.stroke();
                break

                default:
                progctx.fillStyle = "#FF0000";
                progctx.fillRect(x, y, 1, 1);
                progctx.stroke(); 
            }
            


        });

        var dfield = document.querySelector('input[name="d"]');
        var xfield = document.querySelector('input[name="startx"]');
        var yfield = document.querySelector('input[name="starty"]');

        dfield.onchange = function (e) {
            if (dfield.value == "") dfield.value = 0
            var data = {
                d: Number(dfield.value),
            }
            socket.emit('setD', data)
        }

        

        function updateStartPos() {
            var data = {
                x: Number(xfield.value),
                y: Number(yfield.value)
            }
            socket.emit('setStartPos', data)
        }
        xfield.onchange = yfield.onchange = updateStartPos;

        socket.on('DXY', function (data) {
            console.log('DXY', data)
            dfield.value = data.d
            xfield.value = data.x
            yfield.value = data.y
        });

        socket.on('botConnect', function (data) {
            botConnectHandler()
        })
        socket.on('botDisconnect', function (data) {
            botDisconnectHandler()
        })
        socket.on('botConnectionStatus', function (connected) {
            if (connected) {
                botConnectHandler()
            } else {
                botDisconnectHandler()
            }
        })

        function botConnectHandler() {
            rebootButton.classList.remove('fa-spin')
            connectionIndicator.classList.remove('disconnected')
            connectionIndicator.classList.remove('rebooting')
            connectionIndicator.classList.add('connected')
        }
        function botDisconnectHandler() {
            connectionIndicator.classList.remove('rebooting')
            connectionIndicator.classList.remove('connected')
            connectionIndicator.classList.add('disconnected')
        }

        var closeButton = document.querySelector('.close');
        closeButton.addEventListener('click', function (e) {
            toggleSettings();
        });

        var pauseButton = document.querySelector('.pause');
        pauseButton.addEventListener('click', function (e) {
            data = 0;
            socket.emit('pause', data);
        });

        var rebootButton = document.querySelector('.reboot');
        rebootButton.addEventListener('click', function (e) {
            socket.emit('reboot')
            connectionIndicator.classList.remove('connected')
            connectionIndicator.classList.remove('disconnected')
            connectionIndicator.classList.add('rebooting')
            rebootButton.classList.add('fa-spin')
        });



        // drag and drop
        function ParseXML(val) {
            if (window.DOMParser) {
                parser = new DOMParser();
                xmlDoc = parser.parseFromString(val, "text/xml");
            }
            return xmlDoc;
        }

        let dropTarget = document.querySelector('#control');
        dropTarget.ondragover = function () {
            this.className = 'dragover';
            return false;
        }
        dropTarget.ondragend = function () {
            this.className = '';
            return false;
        }
        dropTarget.ondrop = function (e) {
            this.className = '';
            e.preventDefault();

            console.log('dropped!');
            var file = e.dataTransfer.files[0];
            //console.log(file);

            var origcanvas = document.getElementById("originCanvas");
            var origctx = origcanvas.getContext("2d");

            var reader = new FileReader();
            reader.onload = function (evt) {
                var text = evt.target.result;
                console.log(text);
                origctx.drawSvg(text, 0, 0, 480, 600)

                var data = {
                    content: text
                }
                socket.emit('drawart', data);
            };
            reader.readAsText(file);
            return false;
        }
    </script>
</body>

</html>